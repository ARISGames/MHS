<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="viewport" content="width=device-width; user-scalable=no;"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Trading Post</title>
<link href="style.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="utils/json2.js"></script>
<script type="text/javascript" src="utils/arisjs.js"></script>
<script type="text/javascript" src="model.js"></script>
<script type="text/javascript">

var scene = sceneEnumLoading;
var bogusEndOfStateQueueId = 99999999; //Enqueue into getQtyOfItem- when it returns '0', you'll know everything preceding it has finished

function bodyLoad()
{
    if(debug) console.log('bodyLoad()');

    window.onerror = function(msg, url, linenumber) 
    {
        alert('Error message: '+msg+'\nURL: '+url+'\nLine Number: '+linenumber);
        return true;
    };

    //junk to prevent scrolling
    document.ontouchmove = function(e){ e.preventDefault(); };

    setScene(sceneEnumLoading);
    setTimeout(requestState,100);
}

//Fetches all data it needs
function requestState()
{
    if(debug) console.log('requestState()');

    //Get URL Fields
    var params = ARIS.parseURLParams(document.URL);
    gameId     = parseInt(params.gameId);
    playerId   = parseInt(params.playerId);
    webPageId  = parseInt(params.webPageId);
    webPageItem = itemForWebPageId(webPageId);
    webPageRole = webPageItem.owner;

    //preload images
    var tempImg = new Image();
    tempImg.src = "images/objects/splash/"+webPageItem.imageName;
    var tempImg2 = new Image();
    tempImg2.src = "images/roles/splash/"+webPageRole.imageName;


    //This is called by ARIS, informing this webpage of qty values
    ARIS.didUpdateItemQty = function (updatedItemId,qty)
    {
        if(debug) console.log('ARIS.didUpdateItemQty('+updatedItemId+','+qty+')');

        //Knows all enqueued requests have finished
        if(updatedItemId == bogusEndOfStateQueueId)
        {
            stateReceived();
            return;
        }

        //Update local record of qty to sync with ARIS data
        var o;
        if(o = itemForItemId(updatedItemId)) setItemQtyInInventory(o.itemEnum, qty);
        else if(o = levelForLevelId(updatedItemId) && o >= currentLevel) currentLevel = parseInt(o)+1; //Player is at level one greater than the level represented by their inventory (at level 2 when 'level 1' badge in inventory)
        else if(qty > 0 && (o = roleForRoleId(updatedItemId))) currentRole = o;

        if(hasAllNeededItems())
        {
            ARIS.setItemCount(levelIds[currentLevel-1],1);
            currentLevel++;
        }
    }

    //Request sync with ARIS data
    for(var i in items)
        ARIS.getItemCount(items[i].itemId);
    for(var i in levelIds)
        ARIS.getItemCount(levelIds[i]);
    for(var i in roles)
        ARIS.getItemCount(roles[i].roleId);
    ARIS.getItemCount(bogusEndOfStateQueueId); //Enqueued to signal the queue to 'get state' has sufficiently advanced
}

//Once all data is retreived, actually initialize game state
function stateReceived()
{
    if(debug) console.log('stateReceived()');

    if(!currentRole)
    {
        //No role/new to activity- Set itemget screen to new player mode
        document.getElementById('itemgetdescription').innerHTML = "You've received one "+webPageItem.name+"!";
        document.getElementById('itemgetstartactivitybutton').style.display = 'block';
        ARIS.setItemCount(webPageItem.itemId,getItemQtyInInventory(webPageItem.itemEnum)+1);
    }
    else if(currentRole != webPageRole)
    {
        //Scanned item that is conflicting with current role- Set itemget screen to wrong item mode
        document.getElementById('itemgetdescription').innerHTML = "Your role ("+currentRole.name+") can't pick up a "+webPageItem.name+".";
        document.getElementById('itemgetchangerolebutton').style.display = 'block';
    }
    else if(currentLevel == 1)
    {
        //Scanned appropriate item on first level- Set itemget screen to show 'n of m received' message
        document.getElementById('itemgetdescription').innerHTML = "You've received one "+webPageItem.name+"! "+(getItemQtyInInventory(webPageItem.itemEnum)+1)+"/3 in inventory.";
        document.getElementById('itemgetokbutton').style.display = 'block';
        ARIS.setItemCount(webPageItem.itemId,getItemQtyInInventory(webPageItem.itemEnum)+1);
    }
    else
    {
        //Scanned appropriate item on level > 1- Set itemget screen to show that the item was received
        document.getElementById('itemgetdescription').innerHTML = "You've received one "+webPageItem.name+"!";
        document.getElementById('itemgetokbutton').style.display = 'block';
        ARIS.setItemCount(webPageItem.itemId,getItemQtyInInventory(webPageItem.itemEnum)+1);
    }
    document.getElementById('itemgetpic').src = 'images/objects/splash/'+webPageItem.imageName;
    setScene(sceneEnumItemGet);
}

function what()
{
    //Wipe away relevant inventory and start fresh
    for(var i in items)
        completelyRemoveItemFromInventory(items[i].itemId); //Local
    for(var i in items)
        ARIS.setItemCount(items[i].itemId,getItemQtyInInventory(items[i].itemId)); //Back to ARIS

    //Save New Role
    for(var i in roles)
    {
        if(roles[i].roleId == currentRole.roleId)
            ARIS.setItemCount(roles[i].roleId,1); //Back to ARIS
        else
            ARIS.setItemCount(roles[i].roleId,0); //Back to ARIS
    }

    document.getElementById('roleContent').src = "images/roles/splash/"+currentRole.imageName;
    document.getElementById('inventoryIdentifier').src = "images/roles/indicator/"+currentRole.imageName;
    setScene(sceneEnumRole);
}

function setScene(newScene)
{
    if(debug) console.log('setScene('+newScene+')');
    scene = newScene;

    document.getElementById("loading").style.display="none";
    document.getElementById("itemget").style.display="none";
    document.getElementById("intro").style.display="none";
    document.getElementById("chooserole").style.display="none";
    document.getElementById("roleget").style.display="none";

    switch(scene)
    {
        case sceneEnumLoading:
            document.getElementById("loading").style.display="block";
            break;
        case sceneEnumItemGet:
            document.getElementById("itemget").style.display="block";
            break;
        case sceneEnumIntro:
            document.getElementById("intro").style.display="block";
            break;
        case sceneEnumChooseRole:
            document.getElementById("chooserole").style.display="block";
            break;
        case sceneEnumRoleGet:
            document.getElementById("roleget").style.display="block";
            break;
    }
}
            //document.getElementById("bumpvideo").play();
            //document.getElementById("bumpvideo").webkitExitFullscreen();

function startActivityButtonClicked()
{
    setScene(sceneEnumIntro);
}

function chooseRoleButtonClicked()
{
    setScene(sceneEnumChooseRole);
}

function changeRoleButtonClicked()
{
    setScene(sceneEnumChooseRole);
}

function setRoleButtonClicked(roleEnum)
{
    setRole(roleEnum);
    setScene(sceneEnumRoleGet);
}

function okButtonClicked()
{
    ARIS.closeMe();
}

function setRole(roleEnum)
{
    switch(roleEnum)
    {
        case roleEnumHunter:
            ARIS.setItemCount(roles[roleEnumClerk].roleId,0);
            ARIS.setItemCount(roles[roleEnumHunter].roleId,1);
            currentRole = roles[roleEnumHunter];
            break;
        case roleEnumClerk:
            ARIS.setItemCount(roles[roleEnumHunter].roleId,0);
            ARIS.setItemCount(roles[roleEnumClerk].roleId,1);
            currentRole = roles[roleEnumClerk];
            break;
    }
    document.getElementById('rolegetpic').src = 'images/roles/splash/'+currentRole.imageName;
}

//Verify that user is on correct path in game (scanned meaningful item, not switching roles, etc...)
function verify()
{
    if(debug) console.log('verify()');

    //If player was already init'd, and must have gotten here by pressing 'back'
    if(currentRole)
    {
        setScene(sceneEnumRole);
        return;
    }

    //Set up new role
    var newRole = webPageRole;
    //Long if statement, translated to english:
    //If there is no role for the web page (invalid web page id), give them the 'wrong item' screen.
    //Also, if the player is on level one/ hasn't played before, and scanned an item other than the beaver pelt or fabric, send them to the 'wrong item' screen as well.
    if(!newRole || (player.levelComplete == -1 && (newRole.roleId == roleIdCrafter || (webPageItem.itemId != itemIdBeaverpelt && webPageItem.itemId != itemIdFabric))))
    {
        document.getElementById("wrongitem").style.display = "block";
    }
    else if(!currentRole) confirmInit();
    else if(currentRole.roleId != newRole.roleId) //New role
    {
        document.getElementById("rolechangetext").innerHTML = "You were a <b>'"+currentRole.title+"'</b><br />This puts you in the role of <b>'"+newRole.title+"'</b>";
        document.getElementById("rolechange").style.display = "block";
    }
    else //Same role as before
        confirmInit();

}

function checkWinState()
{
    if(debug) console.log('checkWinState()');
    if(scene == sceneEnumTrade && player.hasAllNeededItems())
    {
        setTimeout(function(){document.getElementById("congrats").style.display = "block";},1000);

        //DELETE ME WHEN LEVEL 3 EXISTS
        if(currentLevel == 2) return;
        //END DELETE ME

        ARIS.setItemCount(levelIds[currentLevel],0); //Remove Level badge
    }
}

window.addEventListener('load', bodyLoad, false);
</script>
</head>
<body>
<div id="screen">

<!-- Loading State -->
<div id="loading" class="scene" style="display:block;">
    loading...
</div>

<!-- ItemGet State -->
<div id="itemget" class="scene">
    <img id="itemgetpic" />
    <div id="itemgetdescription"></div>

    <div id="itemgetstartactivitybutton" class="itemgetbutton button" onclick="startActivityButtonClicked()">Start Activity</div>
    <div id="itemgetchangerolebutton" class="itemgetbutton button" onclick="changeRoleButtonClicked()">Change Role</div>
    <div id="itemgetchangerolebutton" class="itemgetbutton button" onclick="okButtonClicked()">Keep Role</div>
    <div id="itemgetokbutton" class="itemgetbutton button" onclick="okButtonClicked()">OK</div>
</div>

<!-- Intro State -->
<div id="intro" class="scene">
    <img id="intropic" src="map_trade.png" onclick="chooseRoleButtonClicked()" />
    <div id="introchooserolebutton" class="introbutton button" onclick="chooseRoleButtonClicked()">Choose Role</div>
</div>

<!-- ChooseRole State -->
<div id="chooserole" class="scene">
    <div id="chooseroletitle">Choose Role</div>
    <div id="chooserolehunterbutton" class="chooserolebutton button" onclick="setRoleButtonClicked(roleEnumHunter)">
        <img id="chooserolehunterpic" class="chooserolepic" src="images/roles/icon/hunter.png" />
        Hunter
    </div>
    <div id="chooseroleclerkbutton" class="chooserolebutton button" onclick="setRoleButtonClicked(roleEnumClerk)">
        <img id="chooseroleclerkpic" class="chooserolepic" src="images/roles/icon/clerk.png" />
        Clerk
    </div>
    <div id="chooseroledescription"></div>
</div>

<!-- RoleGet State -->    
<div id="roleget" class="scene"> 
    <img id="rolegetpic" />
    <div id="rolegetdescription"></div>
    <div id="rolegetokbutton" class="rolegetbutton button" onclick="okButtonClicked()">OK</div>
</div>

<!-- Debug -->
<div id="debug">
    debug
</div> 

</div><!-- body -->
</body>
</html>
