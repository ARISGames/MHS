<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="viewport" content="width=device-width; user-scalable=no;"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Trading Post</title>
<link href="style.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="utils/jquery.js"></script>
<script type="text/javascript" src="utils/json2.js"></script>
<script type="text/javascript" src="utils/arisjs.js"></script>
<script type="text/javascript" src="model.js"></script>
<script type="text/javascript">

var scene = sceneIdIntro;
var oldRole;
var bogusEndOfQueueId = 99999999; //Enqueue into getQtyOfItem- when it returns '0', you'll know everything preceding it has finished

function bodyLoad()
{
    //junk to prevent scrolling
    document.ontouchmove = function(e){ e.preventDefault(); };
    document.getElementById('inventorytable').ontouchmove = function(e) { e.stopPropagation(); };

    if(debug) console.log('bodyLoad()');
    setScene(sceneIdLoading);
    setTimeout(function(){initialize()},100);
}

function setScene(newScene)
{
    if(debug) console.log('setScene('+newScene+')');
    scene = newScene;

    document.getElementById("loading").style.display="none";
    document.getElementById("splash").style.display="none";
    document.getElementById("role").style.display="none";
    document.getElementById("intro").style.display="none";
    document.getElementById("trade").style.display="none";

    switch(scene)
    {
        case sceneIdLoading:
            document.getElementById("loading").style.display="block";
            break;
        case sceneIdSplash:
            document.getElementById("splash").style.display="block";
            break;
        case sceneIdRole:
            document.getElementById("role").style.display="block";
            break;
        case sceneIdIntro:
            document.getElementById("intro").style.display="block";
            break;
        case sceneIdTrade:
            constructBumpString();
            redraw();
            document.getElementById("trade").style.display="block";
            break;
    }
}

//Fetches all data it needs
function initialize()
{
    if(debug) console.log('initialize()');
    //Get URL Fields
    var params = ARIS.parseURLParams(document.URL);
    gameId     = parseInt(params.gameId);
    playerId   = parseInt(params.playerId);
    webPageId  = parseInt(params.webPageId);
    player = new Player();

    //preload images
    var tempImg = new Image();
    tempImg.src = "images/objects/splash/"+itemDescriptionForWebPageId(webPageId).imageName;
    var tempImg2 = new Image();
    tempImg2.src = "images/roles/splash/"+itemDescriptionForWebPageId(webPageId).owner.imageName;

    //This is called by ARIS, informing this webpage of qty values
    ARIS.didUpdateItemQty = function (updatedItemId,qty)
    {
        if(debug) console.log('ARIS.didUpdateItemQty('+updatedItemId+','+qty+')');

        //Knows all enqueued requests have finished
        if(updatedItemId == bogusEndOfQueueId)
        {
            ARIS.didUpdateItemQty = function (updatedItemId,qty) {}; //Detatch this function
            splash();
            return;
        }

        //Update local record of qty to sync with ARIS data
        var i;
        if(i = itemDescriptionForItemId(updatedItemId)) player.setItemQtyInInventory(i.typeId, qty);
        else if(qty > 0 && (i = levelForLevelObjectId(updatedItemId)) != -1 && i > player.level) player.level = parseInt(i); //No idea why parseInt is necessary... oh javascript...
        else if(qty > 0 && (i = playerDescriptionForRoleObjectId(updatedItemId))) oldRole = i;
    
        //Check if update sufficient to change state of game
        if(player.description) //Check if player has been initialized yet
        {
            redraw();
            checkWinState();
        }
    }

    //This is called by ARIS, informing this webpage that a bump occurred
    ARIS.bumpReceived = function(bumpString)
    {
        if(debug) console.log('bumpReceived('+bumpString+')');
        var receivedItems = bumpString.tradedItems;
        for(var i in receivedItems)
        {
            var item;
            if(item = player.addItemToInventory(itemDescriptionForItemId(receivedItems[i]).typeId,1))
                ARIS.setItemCount(item.description.itemId,player.getItemQtyInInventory(item.description.typeId));
        }
    
        var lostItems = [];
        for(var i = 0; i < player.inventory.length; i++) //Needs to be an old fashioned for loop, as normal enumerator can't account for dynamic changes in inventory
        {
            if(player.inventory[i].selected)
            {
                player.inventory[i].selected = false;
                player.inventoryCells[i].drawSelf();
                var item;
                var potentialLostItem = player.inventoryCells[i];
                if(item = player.removeItemFromInventory(player.inventory[i].description.typeId,1));
                {
                    lostItems[lostItems.length] = potentialLostItem;
                    ARIS.setItemCount(item.description.itemId,player.getItemQtyInInventory(item.description.typeId)); //Back to ARIS
                    i--;
                }
            }
        }

        //Animate

        document.getElementById('animcell').style.display = 'none';
        document.getElementById('animcell').innerHTML = "";
        document.getElementById('animcell').style.opacity = '1.0';
        document.getElementById('animcell').style.top = '-400px';
        document.getElementById('animcell').style.left = '26px';
        for(var i = 0; i < lostItems.length; i++)
            document.getElementById('animcell').appendChild(lostItems[i]);
        document.getElementById('animcell').style.display = 'block';

        //jQuery in da house!
        $('#animcell').animate(
            {
                opacity: 0,
                top: -650,
            }, 
            1000, 
            function() {
                document.getElementById('animcell').style.display = 'none';
                document.getElementById('animcell').innerHTML = '';
                document.getElementById('animcell').style.opacity = '0.0';
                document.getElementById('animcell').style.top = '-650px';
                document.getElementById('animcell').style.left = '26px';
                for(var i = 0; i < receivedItems.length; i++)
                    document.getElementById('animcell').appendChild(generateInventoryCell(new Item(itemDescriptionForItemId(receivedItems[i]).typeId)));
                document.getElementById('animcell').style.display = 'block';

                $('#animcell').animate(
                    {
                        opacity: 1,
                        top: -400,
                    }, 
                    1000, 
                    function() {
                        document.getElementById('animcell').innerHTML = '';
                        document.getElementById('animcell').style.display = 'none';
                        redraw();
                        checkWinState();
                        constructBumpString();
                    }
                );
            }
        );
        
    }

    //Request sync with ARIS data
    for(var i in types)
        ARIS.getItemCount(types[i].itemId);
    for(var i in levelObjectIds)
        ARIS.getItemCount(levelObjectIds[i]);
    for(var i in players)
        ARIS.getItemCount(players[i].roleObjectId);
    ARIS.getItemCount(bogusEndOfQueueId); //Enqueued to signal the queue has sufficiently advanced *NOT 100% RELIABLE.
}

//Tell a bit about the item scanned
function splash()
{
    document.getElementById('splashContent').src = "images/objects/splash/"+itemDescriptionForWebPageId(webPageId).imageName;
    setScene(sceneIdSplash);
}

//Verify that user is on correct path in game (scanned meaningful item, not switching roles, etc...)
function verify()
{
    if(debug) console.log('verify()');

    //If player was already init'd, and must have gotten here by pressing 'back'
    if(player.description)
    {
        setScene(sceneIdRole);
        return;
    }

    //Set up new role
    var newRole = itemDescriptionForWebPageId(webPageId).owner;
    if(!newRole)
    {
        document.getElementById("wrongitem").style.display = "block";
    }
    else if(!oldRole) confirmInit();
    else if(oldRole.roleId != newRole.roleId) //New role
    {
        document.getElementById("rolechangetext").innerHTML = "You were a <b>'"+oldRole.title+"'</b><br />This puts you in the role of <b>'"+newRole.title+"'</b>";
        document.getElementById("rolechange").style.display = "block";
    }
    else //Same role as before
        confirmInit();

}

//Once all data is retreived, actually initialize game state
function confirmInit()
{
    //Clear warnings if they've goten this far
    document.getElementById("rolechange").style.display = "none";
    document.getElementById("wrongitem").style.display = "none";

    if(debug) console.log('confirmInit()');
    //Give them the 'Level 1' Badge for starting to play
    if(player.level == -1)
    {
        ARIS.setItemCount(levelObjectIds[0],1); //Back to ARIS
        player.level = 0;
    }

    //Finalize player state, as all data should now be synced with client
    if(!player.construct(itemDescriptionForWebPageId(webPageId).owner)) alert("Error");

    //Check if they are deserving of a reset (new to game, switched role, lost entire inventory)
    if(!oldRole || player.description.roleId != oldRole.roleId || player.inventory.length == 0)
    {
        //Wipe away relevant inventory and start fresh
        for(var i in types)
            player.completelyRemoveItemFromInventory(types[i].typeId); //Local
        for(var i in player.givenItems)
            player.addItemToInventory(player.givenItems[i].typeId,1); //Local
        for(var i in types)
            ARIS.setItemCount(types[i].itemId,player.getItemQtyInInventory(types[i].typeId)); //Back to ARIS

        //Save New Role
        for(var i in players)
        {
            if(players[i].roleId == player.description.roleId)
                ARIS.setItemCount(players[i].roleObjectId,1); //Back to ARIS
            else
                ARIS.setItemCount(players[i].roleObjectId,0); //Back to ARIS
        }
    }
    document.getElementById('roleContent').src = "images/roles/splash/"+player.description.imageName;
    setScene(sceneIdRole);
}

function playIntro(state)
{
    if(debug) console.log('playIntro('+state+')');
    document.getElementById("introArrow").onclick=function(){playIntro(state+1);};
    switch(state)
    {
        case 0:
            setScene(sceneIdIntro);
            break;
        case 1:
            setScene(sceneIdTrade);
            break;
    }
}

function redraw()
{
    if(debug) console.log('redraw()');
    document.getElementById('inventorytable').innerHTML = "";
    if(scene == sceneIdTrade)
    {
        player.markMeaningfulInventoryContents();
        for(var i = 0; i < player.neededItems.length; i++)
        {
            if(player.neededItems[i].selected)
                document.getElementById('needCell'+i).innerHTML = "<img class='needbox' src='images/objects/checklists/checked/"+player.neededItems[i].description.imageName+"'/>";
            else
                document.getElementById('needCell'+i).innerHTML = "<img class='needbox' src='images/objects/checklists/unchecked/"+player.neededItems[i].description.imageName+"'/>";
        }
    
        for(var i = 0; i < player.inventoryCells.length; i++)
            document.getElementById('inventorytable').appendChild(player.inventoryCells[i]);
    }
}

function checkWinState()
{
    if(debug) console.log('checkWinState()');
    if(scene == sceneIdTrade && player.hasAllNeededItems())
    {
        setTimeout(function(){document.getElementById("congrats").style.display = "block";},1000);
        ARIS.setItemCount(levelObjectIds[player.level],0); //Remove old level badge
        ARIS.setItemCount(levelObjectIds[player.level+1],1); //Give new level badge
    }
}

function constructBumpString()
{
    if(debug) console.log('constructBumpString()');
    var bumpString = "{\"tradedItems\":[";
    for(var i in player.inventory)
    {
        if(player.inventory[i].selected)
            bumpString += player.inventory[i].description.itemId+",";
    }
    //Remove potential trailing ','
    if(bumpString.charAt(bumpString.length-1) == ",")
        bumpString = bumpString.slice(0,-1);

    bumpString += "]}";
    ARIS.setBumpString(bumpString);
    return bumpString;
}

</script>
</head>
<body onLoad="bodyLoad()">
<div id="screen">

<!-- Loading State -->
<div id="loading" class="scene" style="display:block;">
    loading...
</div>

<!-- Splash State -->
<div id="splash" class="scene">
    <img id="splashContent"/>
    <img class="right_arrow" src="images/core/right_arrow.png" onclick="verify()"/>

    <div id="wrongitem" class="alert">
        <img id="wrongitemalert" src="images/core/dontneed_alert.png" onclick="ARIS.closeMe()"/>
    </div>
    <div id="rolechange" class="alert">
        <img id="rolechangealert" src="images/core/switchroles_alert.png"/>
        <div id="rolechangetext"></div>
        <div id="rolechangeoptions">
            <img id="keeprole_button" src="images/core/keeprole_button.png" onclick="ARIS.closeMe()"/>
            <img id="switchrole_button" src="images/core/switchrole_button.png" onclick="confirmInit()"/>
        </div>
    </div>
</div>

<!-- Role State -->
<div id="role" class="scene">
    <img id="roleContent"/>
    <img class="left_arrow" src="images/core/left_arrow.png" onclick="setScene(sceneIdSplash)"/>
    <img class="right_arrow" src="images/core/right_arrow.png" onclick="playIntro(0)"/>
</div>

<!-- Intro State -->
<div id="intro" class="scene">
    Movie
    <img class="left_arrow" src="images/core/left_arrow.png" onclick="setScene(sceneIdRole)"/>
    <img id="introArrow" class="right_arrow" src="images/core/right_arrow.png" onclick="verify()"/>
</div>

<!-- Trade State -->    
<div id="trade" class="scene"> 
    <img id="inventoryBackground" src="images/core/inventory_background.png"/>
    <div id="inventorytable">
    </div>
    <table id="needTable">
    <tr><td style="width:50%;">
    <div id="needCell0"></div>
    </td><td>
    <div id="needCell1"></div>
    </td></tr>
    <tr><td>
    <div id="needCell2"></div>
    </td><td>
    <div id="needCell3"></div>
    </td></tr>
    </table>

    <div id="animcell">
    </div>

    <div id="congrats" class="alert">
        <img id="congratsalert" src="images/core/congrats_alert.png" onclick="ARIS.closeMe()"/>
    </div>

</div>


<!-- Debug -->
<div id="debug">
    debug
</div> 

</div><!-- body -->
</body>
</html>
