<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name = "viewport" content = "width=device-width, user-scalable=no" />
<title>Trading Post</title>
<script type = "text/javascript" src = "arisjs.js"></script>
<script type = "text/javascript" src = "json2.js"></script>
<script type = "text/javascript">

function loadMe()
{
    setTimeout(function(){initialize()},delay);
}

function setScene(scene)
{
    //alert("Setting scene: "+scene);
    document.getElementById("loading").style.display="none";
    document.getElementById("intro").style.display="none";
    document.getElementById("trade").style.display="none";
    document.getElementById("win").style.display="none";

    switch(scene)
    {
        case sceneLoading:
            document.getElementById("loading").style.display="block";
            break;
        case sceneIntro:
            document.getElementById("intro").style.display="block";
            break;
        case sceneTrade:
            document.getElementById("trade").style.display="block";
            break;
        case sceneWin:
            document.getElementById("win").style.display="block";
            break;
    }
}

//Constants
var delay = 300;
//Enums
var sceneLoading = 0;
var sceneIntro = 1;
var sceneTrade = 2;
var sceneWin = 3;
var wpClerk = 0;
var wpHunter = 1;
var wpCrafter = 2;
var roleClerk = 0;
var roleHunter = 1;
var roleCrafter = 2;
var bogusFinishReadyId = 99999999; //Call 'getQtyOfItem' with this after all other intro requests are queued. When we get this back, we know that everything else has returned

//Game Data
var gameId; 
var playerId;
var webPageId;
var introItemId;

var levelItemIds = [13,14,15];//Level 0,1
var itemIds =      [1,2,3,4,5,6,7,8,9,10,11,12];
var itemQtys =     [0,0,0,0,0,0,0,0,0,0, 0, 0];
var itemSelected = [0,0,0,0,0,0,0,0,0,0, 0, 0];
var itemOwners = [roleHunter, roleHunter, roleHunter, roleHunter, roleClerk, roleClerk, roleCrafter, roleCrafter, roleCrafter, roleCrafter, roleClerk, roleClerk];
var roleTitles = ["Clerk", "Hunter", "Crafter"];    
var itemNames = ["Beaver Pelt","Deer Meat","Leather","Raw Hide Lacing","Guns","Coat","Wild Rice","Maple Sugar","Snowshoes","Moccasins","Beads","Blanket"];
var itemImages = ["./images/beaverpelt.png","./images/deermeat.png","./images/leather.png","./images/lace.png","./images/gun.png","./images/coat.png","./images/wildrice.png","./images/maplesugar.png","./images/snoeshow.png","./images/moccasins.png","./images/beads.png","./images/blanket.png"];
var itemImages96 = ["./images/beaverpelt96.png","./images/deermeat96.png","./images/leather96.png","./images/lace96.png","./images/gun96.png","./images/coat96.png","./images/wildrice96.png","./images/maplesugar96.png","./images/snoeshow96.png","./images/moccasins96.png","./images/beads96.png","./images/blanket96.png"];
var itemWebpageId = [757,758,759,760,761,762,763,764,765,766,767,768];

//*NOTE*- 
// These next two arrays are *NOT* holding values of item ids, rather, indexes into the itemId array that DOES hold the item IDs.
// This is to allow for one-spot switching of item IDs, and these can be used consistently in functions that rely on the 
// parallelocity of the 'itemIds', 'itemQtys', 'itemImages', etc... arrays
var roleItemIndexes = [ //Items to start out with given your role
    [[4], [0], [6]], //Level 1
    [[4,5,10,11], [0,1,2,3], [6,7,8,9]], //Level 2
    [[4,5,10,11], [0,1,2,3], [6,7,8,9]] //Level 3
    ];
var wantedItemIndexes = [ //Items to strive for, given your goal. 
    [[0], [4], [2]], //Level 1
    [[0,1,8,9], [4,5,6,7], [2,3,10,11]], //Level 2
    [[0,1,8,9], [4,5,6,7], [2,3,10,11]] //Level 3
    ];

    //Variables
    var ready = false;
    var introduced = false;
    var pLevel=0;
    var pName;
    var pRole;

function initialize()
{
    //Get PlayerID and GameID from URL
    var params = parseURLParams(document.URL);
    gameId = parseInt(params.gameId);
    playerId = parseInt(params.playerId);
    webPageId = parseInt(params.webPageId);

    for(levelIdIndex in levelItemIds)
        getItemCount(levelItemIds[levelIdIndex]);

    getItemCount(bogusFinishReadyId);
    refreshItemCounts();
}

function synchronizeToWebId(webId)
{
    switch(webId){
        case itemWebpageId[0]:
            introItemId = 1;
            break;
        case itemWebpageId[1]:
            introItemId = 2;
            break;
        case itemWebpageId[2]:
            introItemId = 3;
            break;
        case itemWebpageId[3]:
            introItemId = 4;
            break;
        case itemWebpageId[4]:
            introItemId = 5;
            break;
        case itemWebpageId[5]:
            introItemId = 6;
            break;
        case itemWebpageId[6]:
            introItemId = 7;
            break;
        case itemWebpageId[7]:
            introItemId = 8;
            break;
        case itemWebpageId[8]:
            introItemId = 9;
            break;
        case itemWebpageId[9]:
            introItemId = 10;
            break;
        case itemWebpageId[10]:
            introItemId = 11;
            break;
        case itemWebpageId[11]:
            introItemId = 12;
            break;
    }
    switch(introItemId)
    {
        case 1:
        case 2:
        case 3:
        case 4:
            pName = "Hunter";
            pRole = roleHunter;
            break;
        case 5:
        case 6:
            pName = "Clerk";
            pRole = roleClerk;
            break;
        case 7:
        case 8:
        case 9:
        case 10:
            if(pLevel > 0)
            {
                pName = "Crafter";
                pRole = roleCrafter;
            }
            else
            {
                introItemId=3;
                pName = "Hunter";
                pRole = roleHunter;
            }
            break;
        case 11:
        case 12:
            pName = "Clerk";
            pRole = roleClerk;
            break;
    }
    //document.getElementById(""+introItemId).innerHTML+=introItemId;
    document.getElementById(""+introItemId).style.display="block";
    document.getElementById("roleTitle").innerHTML = pName;
}

function introduce()
{
    //alert("introducing...");
    //alert(pName);
    document.getElementById(pName).display = "block";
    //alert("pRole"+pRole);
    //alert("pLevel"+pLevel);
    //alert(roleItemIndexes[0][0][0]);
    for(roleIndex in roleItemIndexes[pLevel])
    {
        //alert("index"+index);
        for(index in roleItemIndexes[pLevel][roleIndex])
        {
            if(roleIndex == pRole)
            {
                setItemCount(itemIds[roleItemIndexes[pLevel][roleIndex][index]],1);
                itemQtys[roleItemIndexes[pLevel][roleIndex][index]] = 1;
            }
            else
            {
                takeItemCount(itemIds[roleItemIndexes[pLevel][roleIndex][index]],999);
                itemQtys[roleItemIndexes[pLevel][roleIndex][index]] = 0;
            }
        }
    }
    //alert(JSON.stringify(itemQtys));
    draw();
    //alert("doneIntroducing");
    setScene(sceneIntro);
    introduced = true;
}

function draw()
{
    if(ready)
        document.getElementById("tradeTable").innerHTML = constructTradeTableHTML();
}

function refreshItemCounts()
{
    for(itemId in itemIds)
        getItemCount(itemIds[itemId]);
}

function didUpdateItemQty(updatedItemId,qty)
{
    if(updatedItemId == bogusFinishReadyId)
    {
        synchronizeToWebId(webPageId);
        introduce();
        ready = true;
        return;
    }
    //alert("Found Item "+updatedItemId+" of qty "+qty);
    var newItem = false;
    for(itemIndex in itemIds)
    {
        if(updatedItemId == itemIds[itemIndex])
        {
            itemQtys[itemIndex]=qty;
            newItem = true;
        }
    }
    if(newItem) draw();

    for(levelIdIndex in levelItemIds)
        if(updatedItemId == levelItemIds[levelIdIndex] && qty > 0)
            if(pLevel <= levelIdIndex) pLevel = 1;//levelIdIndex+1;

    checkWinState();
}

function checkWinState()
{
    if(!ready || !introduced) return false;
    //alert(JSON.stringify(itemQtys));
    for(index in wantedItemIndexes[pLevel][pRole])
    {
        //alert("Index:"+index+" Level:"+pLevel+" Role:"+pRole);
        if(itemQtys[wantedItemIndexes[pLevel][pRole][index]] <= 0)
            return false; //do nothing
    }

    //If it gets here, we've won
    setScene(sceneWin);
    setItemCount(levelItemIds[pLevel],1);
}

function wasSelected(itemIndex)
{
    //alert("Selected "+itemIndex);
    itemSelected[itemIndex] = 1;
    constructBumpString();
    draw();
}

function wasDeselected(itemIndex)
{
    //alert("DeSelected "+itemIndex);
    itemSelected[itemIndex] = 0;
    constructBumpString();
    draw();
}

function bumpReceived(bumpString)
{
    var newItems = bumpString.tradedItems;
    //document.getElementById("debug").innerHTML+="1";
    for(items in newItems)
    {
        //document.getElementById("debug").innerHTML+="2";
        for(itemIndex in itemIds)
            if(itemIds[itemIndex] == newItems[items])
            {
                itemQtys[itemIndex]++;
                setItemCount(itemIds[itemIndex],itemQtys[itemIndex]);
            }
    }

    for(itemIndex in itemIds)
    {
        //document.getElementById("debug").innerHTML+="3";
        if(itemSelected[itemIndex])
        {
            if(itemQtys[itemIndex] > 0) itemQtys[itemIndex]--;
            itemSelected[itemIndex] = 0;
            setItemCount(itemIds[itemIndex],itemQtys[itemIndex]);
        }
    }
    //document.getElementById("debug").innerHTML+="4";
    constructBumpString();
}

function constructBumpString()
{
    var bumpString = "{\"tradedItems\":[";
    for(itemIndex in itemIds)
    {
        if(itemSelected[itemIndex])
            bumpString += itemIds[itemIndex]+",";
    }
    if(bumpString.charAt(bumpString.length-1) == ",")
        bumpString = bumpString.slice(0,-1);

    bumpString += "]}";
    setBumpString(bumpString);
    return bumpString;
}

function constructTableCellHTML(itemIndex, inventorySide)
{
    var cellHTML = "";
    if(inventorySide)
    {
        if(itemSelected[itemIndex]) //was selected
            cellHTML+="<div onClick='wasDeselected("+itemIndex+")' style='background-color:#D1E0FF;'><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+" Qty:"+itemQtys[itemIndex]+"</div>";
        else
            cellHTML+="<div onClick='wasSelected("+itemIndex+")'><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+" Qty:"+itemQtys[itemIndex]+"</div>";
    }
    else
    {
        if(itemQtys[itemIndex]) //was found
            cellHTML+="<div style='background-color:#D1FFE0;'><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+"</div>";
        else
            cellHTML+="<div><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+"</div>";
    }
    return cellHTML;
}

function constructTradeTableHTML()
{
    var tableHtml = "<table width='100%' ><tr><td width='50%'>Inventory<br /><br /></td><td width='50%'>Want</td></tr>";
    var inventoryIndex = 0;
    for(var i = 0; i < itemIds.length; i++)
    {
        tableHtml+="<tr><td>";
        //Ok, this part is weird, but you're just gonna have to trust me
        while(inventoryIndex < itemQtys.length && itemQtys[inventoryIndex]<=0)
            inventoryIndex++;
        if(inventoryIndex < itemQtys.length)
            tableHtml+=constructTableCellHTML(inventoryIndex,1);
        inventoryIndex++;
        tableHtml+="</td><td>";
        if(i < wantedItemIndexes[pLevel][pRole].length)
            tableHtml+=constructTableCellHTML(wantedItemIndexes[pLevel][pRole][i],0);
        tableHtml+="</td></tr>";
    }
    tableHtml += "</table>";
    //alert(tableHtml);
    return tableHtml;
}

function getAdvice()
{
    var neededItems = new Array();
    for(itemIndexes in wantedItemIndexes[pLevel][pRole]){
        if(itemQtys[wantedItemIndexes[pLevel][pRole][itemIndexes]] < 1){
            neededItems.push(wantedItemIndexes[pLevel][pRole][itemIndexes]);
        }
    }
    var itemAdviceIndex = Math.floor(Math.random()*neededItems.length);
    var advice = "It looks like you still need to find " + itemNames[neededItems[itemAdviceIndex]] + ". A " + roleTitles[itemOwners[neededItems[itemAdviceIndex]]] + " may have what you need."
        alert(advice);
}

</script>
<style>
div
{
    /*
        border-style:solid;
        border-width:1px;
        border-color:#FF0000;
    */
    padding:0px;
    font-weight:Bold;
}

body
{
  -webkit-user-select:none;
  user-select:none;
  background-color:#FFFFFF;
  color:#888888;
}

.scene
{
  /* For some reason, adding border fixes the white bar at the top. */
  border-style:solid;
  border-width:2px;
  border-color:#000000;
  width:100%;
  height:100%;
  display:none;
  /*background-color:#000000;*/
}

.introItem
{
  display:none;
}

</style>
</head>
<body onLoad="loadMe()" style="margin:0px; padding:0px;">
<div id="tradeScreen" style="position:relative; margin:0px; width:320px; height:416px;">

<!-- Loading State -->
<div id="loading" class="scene" style="display:block;">
  <div style="color:#FFFFFF; position:absolute; top:198px; left:130px; height:20px; width:60px;">
  loading...
  </div>
</div>

<!-- Intro State -->
<div style="background-image:url('images/Fur_Trade_Screen_Intro.png')"; id="intro" class="scene"  onClick="setScene(2)">
    <div id="Clerk">
    	<div id="12" class="introItem">
            <p align="center">You have picked up a <strong><em>blanket</em></strong>:</p>
            <p align="center"><img src="./images/blanket96.png" width="300" height="100" /></p>
            <p align="center">Clerks trade blankets with hunters and crafters or other goods and services to keep their business growing. </p>
            <p align="center"><img src="./images/clerk.jpg" width="197" height="217" /></p>
            <p align="center">You are now a <strong><em>clerk</em></strong>. Trade your blankets and other goods to gain beaver pelts, deer meat, snowshoes, and moccasins. </p>
            <p align="center">Go Trade!</p>
            <p align="center"><img src="./images/start trading.jpg" width="140" height="40" /></p>
        </div>
        <div id="11" class="introItem">
            <p align="center">You have picked up <strong><em>beads</em></strong>:</p>
            <p align="center"><img src="./images/beads96.png" width="198" height="102" /></p>
            <p align="center">Clerks trade beads with hunters and crafters for other goods and services to keep their business growing. </p>
            <p align="center"><img src="./images/clerk.jpg" width="197" height="217" /></p>
            <p align="center">You are now a <strong><em>clerk</em></strong>. Trade your beads and other goods to gain beaver pelts, deer meat, snowshoes and moccasins. </p>
            <p align="center">Go Trade!</p>
            <p align="center"><img src="./images/start trading.jpg" width="140" height="40" /></p>
        </div>
        <div id="5" class="introItem">
            This item doesn't exist! (but is still consistent with the programming model!)
        </div>
        <div id="6" class="introItem">
            This item doesn't exist! (but is still consistent with the programming model!)
        </div>
    </div>
    <div id="Hunter">
        <div id="1" class="introItem">
            <p align="center">You have picked up a <strong><em>beaver pelt</em></strong>:</p>
            <p align="center"><img src="./images/beaverpelt96.png" width="109" height="98" /></p>
            <p align="center">Hunters trade their beaver pelts with clerks and crafters for other goods and services that help them to survive and hunt better. </p>
            <p align="center"><img src="./images/Hunter.jpg" width="180" height="229" /></p>
            <p align="center">You are now a <strong><em>hunter</em></strong>. Trade your pelt and other goods to gain guns, wild rice, coats, and moccasins. </p>
            <p align="center">Go Trade!</p>
            <p align="center"><img src="./images/start trading.jpg" width="140" height="40" /></p>
        </div>
        <div id="3" class="introItem">
            <p align="center">You have picked up <strong><em>leather</em></strong>:</p>
            <p align="center"><img src="./images/leather96.png" width="129" height="109" /></p>
            <p align="center">Hunters trade leather with clerks and crafters for other goods and services that help them to survive and hunt better. </p>
            <p align="center"><img src="./images/Hunter.jpg" width="180" height="229" /></p>
            <p align="center">You are now a <strong><em>hunter</em></strong>. Trade your leather and other goods to gain guns, wild rice, coats, and moccasins. </p>
            <p align="center">Go Trade!</p>
            <p align="center"><img src="./images/start trading.jpg" width="140" height="40" /></p>
        </div>
        <div id="2" class="introItem">
            This item doesn't exist! (but is still consistent with the programming model!)
        </div>
        <div id="4" class="introItem">
            This item doesn't exist! (but is still consistent with the programming model!)
        </div>
    </div>
    <div id="Crafter">
        <div id="9" class="introItem">
            <p align="center">You have picked up <strong><em>snowshoes</em></strong>:</p>
            <p align="center"><img src="./images/snoeshow96.png" width="150" height="194" /></p>
            <p align="center">Crafters trade snowshoes with  clerks and hunters for other goods and services to support their families. </p>
            <p align="center"><img src="./images/crafter.jpg" width="187" height="263" /></p>
            <p align="center">You are now a <strong><em>crafter</em></strong>. Trade your snowshoes and other goods to gain beads, blankets, leather, and raw hide lacing. </p>
            <p align="center">Go Trade!</p>
            <p align="center"><img src="./images/start trading.jpg" width="140" height="40" /></p>
        </div>
        <div id="10" class="introItem">
            <p align="center">You have picked up <strong><em>moccasins</em></strong>:</p>
            <p align="center"><img src="./images/moccasins96.png" width="187" height="123" /></p>
            <p align="center">Crafters trade moccasins with  clerks and hunters for other goods and services to support their families. </p>
            <p align="center"><img src="./images/crafter.jpg" width="187" height="263" /></p>
            <p align="center">You are now a <strong><em>crafter</em></strong>. Trade your moccasins and other goods to gain beads, blankets, leather, and raw hide lacing. </p>
            <p align="center">Go Trade!</p>
            <p align="center"><img src="./images/start trading.jpg" width="140" height="40" /></p>
        </div>
        <div id="7" class="introItem">
            <p align="center">You have picked up <strong><em>wild rice</em></strong>:</p>
            <p align="center"><img src="./images/wildrice96.png" width="193" height="135" /></p>
            <p align="center">Crafters trade wild rice  with  clerks and hunters for other goods and services to support their families. </p>
            <p align="center"><img src="./images/crafter.jpg" width="187" height="263" /></p>
            <p align="center">You are now a <strong><em>crafter</em></strong>. Trade your wild rice and other goods to gain beads, blankets, leather, and raw hide lacing. </p>
            <p align="center">Go Trade!</p>
            <p align="center"><img src="./images/start trading.jpg" width="140" height="40" /></p>
        </div>
        <div id="8" class="introItem">
            This item doesn't exist! (but is still consistent with the programming model!)
        </div>
    </div>
    <div id="Hunter">
    </div>
    <div id="Crafter">
    </div>
</div>

<!-- Trade State -->    
<div style="color:#000000; background-image:url('images/Fur_Trade_Screen_Have_Want_Bkg.png');"; id="trade" class="scene"> <!-- style="background-image:url('images/background7.jpg');" -->
<!--
 <div id="bumpLogo" class="subtitle">
 </div>
-->
 <div id="roleTitle" style="margin:0 auto;">
 </div>
    
 <div id="tradeTable">
    <!-- html gets directly injected into this; hardcode stuff here at own discretion -->
 </div>

 <!-- <div id="debug">
 debug
 </div> -->
    
 <div id="helperArea" style="position:absolute; bottom:0;">
    <img src="images/voyageur.png" width="50" height="50" onClick="getAdvice()"/>
 </div>

</div>

<!-- Win State -->
<div id="win" class="scene" style="background-color:#000000;">
  <div style="color:#FFFFFF; position:absolute; top:198px; left:130px; height:20px; width:60px;">
      YOU WIN
  </div>
</div>

</div><!-- body -->
</body>
</html>
