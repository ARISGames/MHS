<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="viewport" content="width=device-width; user-scalable=no;"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Trading Post</title>
<link href="style.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="utils/json2.js"></script>
<script type="text/javascript" src="utils/arisjs.js"></script>
<script type="text/javascript" src="model.js"></script>
<script type="text/javascript">

var scene = sceneEnumLoading;
var bogusEndOfStateQueueId = 99999999; //Enqueue into getQtyOfItem- when it returns '0', you'll know everything preceding it has finished

function bodyLoad()
{
    if(debug) console.log('bodyLoad()');

    window.onerror = function(msg, url, linenumber) 
    {
        alert('Error message: '+msg+'\nURL: '+url+'\nLine Number: '+linenumber);
        return true;
    };

    //junk to prevent scrolling
    document.ontouchmove = function(e){ e.preventDefault(); };

    setScene(sceneEnumLoading);
    setTimeout(requestState,100);
}

//Fetches all data it needs
function requestState()
{
    if(debug) console.log('requestState()');

    //Get URL Fields
    var params = ARIS.parseURLParams(document.URL);
    gameId     = parseInt(params.gameId);
    playerId   = parseInt(params.playerId);
    webPageId  = parseInt(params.webPageId);
    showGoal = parseInt(params.showGoal);
    showChores = parseInt(params.showChores);
    itemChore.delta = parseInt(params.choreDelta);
    itemFood.delta = parseInt(params.foodDelta);
    itemFood.goal = parseInt(params.foodGoal);
    itemHealth.delta = parseInt(params.healthDelta);
    itemHealth.goal = parseInt(params.healthGoal);
    itemHeat.delta = parseInt(params.heatDelta);
    itemHeat.goal = parseInt(params.heatGoal);

    //This is called by ARIS, informing this webpage of qty values
    ARIS.didUpdateItemQty = function (updatedItemId,qty)
    {
        if(debug) console.log('ARIS.didUpdateItemQty('+updatedItemId+','+qty+')');

        //Knows all enqueued requests have finished
        if(updatedItemId == bogusEndOfStateQueueId)
        {
            stateReceived();
            return;
        }

        //Update local record of qty to sync with ARIS data
        var o;
        if(o = itemForItemId(updatedItemId)) items[o.itemEnum].qty = qty;
    }

    //Request sync with ARIS data
    for(var i in items)
        ARIS.getItemCount(items[i].itemId);
    ARIS.getItemCount(bogusEndOfStateQueueId); //Enqueued to signal the queue to 'get state' has sufficiently advanced
}

//Once all data is retreived, actually initialize game state
function stateReceived()
{
    if(debug) console.log('stateReceived()');
    
    for(var i = 0; i < items.length; i++)
    {
        if(items[i].name == "chore")
        {
            var chorepacity = itemChore.qty; //float 0.0-5.0
            document.getElementById('choreslotimg1').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-0.0));
            document.getElementById('choreslotimg2').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-1.0));
            document.getElementById('choreslotimg3').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-2.0));
            document.getElementById('choreslotimg4').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-3.0));
            document.getElementById('choreslotimg5').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-4.0));
        }
        else
        {
            if(items[i].qty != 0)
                document.getElementById(items[i].name+"bar").style.height = (Math.round(items[i].qty*110)+20)+"px";
            if(items[i].goal != 0)
                document.getElementById(items[i].name+"goalbar").style.height = (Math.round(items[i].goal*110)+20)+"px";
            if((items[i].qty + items[i].delta) > 5) items[i].delta = 5-items[i].qty;
            if((items[i].qty + items[i].delta) < 0) items[i].delta = 0-items[i].qty;
        }
    }

    setScene(sceneEnumContent);
    setTimeout(function(){ animate(0);}, 1000);
}

function animate(progress)
{
    console.log('animate('+progress+')');
    for(var i = 0; i < items.length; i++)
        if(items[i].qty + items[i].delta != 0) document.getElementById(items[i].name+"bar").style.height = Math.round((items[i].qty + (((progress/100) * items[i].delta))*110)+20)+"px";

    var chorepacity = (itemChore.qty+((progress/100)*itemChore.delta)); //float 0.0-5.0
    document.getElementById('choreslotimg1').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-0.0));
    document.getElementById('choreslotimg2').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-1.0));
    document.getElementById('choreslotimg3').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-2.0));
    document.getElementById('choreslotimg4').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-3.0));
    document.getElementById('choreslotimg5').style.opacity = Math.min(1.0,Math.max(0.0,chorepacity-4.0));

    if(progress < 100)
        setTimeout(function(){animate(progress+1);}, 10);
    else
    {
        ARIS.setItemCount(itemFood.itemId, itemFood.qty+itemFood.delta);
        ARIS.setItemCount(itemHealth.itemId, itemHealth.qty+itemHealth.delta);
        ARIS.setItemCount(itemHeat.itemId, itemHeat.qty+itemHeat.delta);
        ARIS.setItemCount(itemChore.itemId, itemChore.qty+itemChore.delta);
    }
}

function setScene(newScene)
{
    if(debug) console.log('setScene('+newScene+')');
    scene = newScene;

    document.getElementById("loading").style.display="none";
    document.getElementById("content").style.display="none";

    switch(scene)
    {
        case sceneEnumLoading:
            document.getElementById("loading").style.display="block";
            break;
        case sceneEnumContent:
            document.getElementById("content").style.display="block";
            break;
    }
}

window.addEventListener('load', bodyLoad, false);
</script>
</head>
<body>
<div id="screen">

<!-- Loading State -->
<div id="loading" class="scene" style="display:block;">
    loading...
</div>

<!-- Content State -->
<div id="content" class="scene">
    <div id="graph">
        <div id="food" class="variable">
            <div id="foodgoalbar" class="bar goalbar">GOAL</div>
            <div id="foodbar" class="bar"></div>
            <div id="foodicon" class="icon"><img class="iconimg" src='assets/food.png' /></div>
            <div id="foodtext" class="text">FOOD</div>
        </div>
        <div id="health" class="variable">
            <div id="healthgoalbar" class="bar goalbar">GOAL</div>
            <div id="healthbar" class="bar"></div>
            <div id="healthicon" class="icon"><img class="iconimg" src='assets/health.png' /></div>
            <div id="healthtext" class="text">HEALTH</div>
        </div>
        <div id="heat" class="variable">
            <div id="heatgoalbar" class="bar goalbar">GOAL</div>
            <div id="heatbar" class="bar"></div>
            <div id="heaticon" class="icon"><img class="iconimg" src='assets/heat.png' /></div>
            <div id="heattext" class="text">HEAT</div>
        </div>
    </div>
    <div id="chore">
        <div id="choretext" >Activities Remaining:</div>
        <div id="chorebar">
            <div id="choreslot1" class="choreslot">
                <img src="assets/chore_box.png" class="choreslotimg choreslotdefault" />
                <img src="assets/chore_check.png" id="choreslotimg1" class="choreslotimg" />
            </div>
            <div id="choreslot2" class="choreslot">
                <img src="assets/chore_box.png" class="choreslotimg choreslotdefault" />
                <img src="assets/chore_check.png" id="choreslotimg2" class="choreslotimg" />
            </div>
            <div id="choreslot3" class="choreslot">
                <img src="assets/chore_box.png" class="choreslotimg choreslotdefault" />
                <img src="assets/chore_check.png" id="choreslotimg3" class="choreslotimg" />
            </div>
            <div id="choreslot4" class="choreslot">
                <img src="assets/chore_box.png" class="choreslotimg choreslotdefault" />
                <img src="assets/chore_check.png" id="choreslotimg4" class="choreslotimg" />
            </div>
            <div id="choreslot5" class="choreslot">
                <img src="assets/chore_box.png" class="choreslotimg choreslotdefault" />
                <img src="assets/chore_check.png" id="choreslotimg5" class="choreslotimg" />
            </div>
        </div>
    </div>
</div>

<!-- Debug -->
<div id="debug">
    debug
</div> 

</div><!-- body -->
</body>
</html>
