<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name = "viewport" content = "width=device-width, user-scalable=no" />
<title>Trading Post</title>
<script type = "text/javascript" src = "arisjs.js"></script>

<script type = "text/javascript">

function loadMe()
{
    setTimeout(function(){initialize()},delay);
}

function setScene(scene)
{
    alert(scene);
    document.getElementById("loading").style.display="none";
    document.getElementById("intro").style.display="none";
    document.getElementById("trade").style.display="none";
    document.getElementById("win").style.display="none";

    switch(scene)
    {
        case sceneLoading:
            document.getElementById("loading").style.display="block";
            break;
        case sceneIntro:
            document.getElementById("intro").style.display="block";
            break;
        case sceneTrade:
            document.getElementById("trade").style.display="block";
            break;
        case sceneWin:
            document.getElementById("win").style.display="block";
            break;
    }
}

//Constants
var delay = 300;
//Enums
var sceneLoading = 0;
var sceneIntro = 1;
var sceneTrade = 2;
var sceneWin = 3;
var wpClerk = 0;
var wpHunter = 1;
var wpCrafter = 2;
var roleClerk = 0;
var roleHunter = 1;
var roleCrafter = 2;
var currentLevel = 0;
var bogusFinishReadyId = 99999999; //Call 'getQtyOfItem' with this after all other intro requests are queued. When we get this back, we know that everything else has returned
var ready = false;

//Game Data
var gameId; 
var playerId;
var webPageId;
    
var levelItemIds = [13,14];//Level 0,1
var itemIds =      [1,2,3,4,5,6,7,8,9,10,11,12];
var itemQtys =     [0,0,0,0,0,0,0,0,0,0, 0, 0];
var itemSelected = [0,0,0,0,0,0,0,0,0,0, 0, 0];
var itemNames = ["Guiding*","Furs","Leather","Work","Guns","iPads","Food","Work2*","Snowshoes","Moccasins","Beads","Fabric"];
var itemImages = ["./images/guiding_icon.jpg","./images/Beaver_pelt_icon.png","./images/leather_icon.png","./images/work_icon.jpg","./images/gun_icon.jpg","./images/Ipad_icon.png","wild_rice_icon.jpg","work2_icon.jpg","./images/Snowshoes_icon.png","./images/moccasins_icon.jpg","./images/beads_icon.jpg","fabric_icon.jpg"];
//*NOTE*- 
// These next two arrays are *NOT* holding values of item ids, rather, indexes into the itemId array that DOES hold the item IDs.
// This is to allow for one-spot switching of item IDs, and these can be used consistently in functions that rely on the 
// parallelocity of the 'itemIds', 'itemQtys', 'itemImages', etc... arrays
var roleItemIndexes = [ //Items to start out with given your role
                        [[4,5,10,11], [0,1,2,3], [6,7,8,9]], //Level 0
                        [[4,5,10,11], [0,1,2,3], [6,7,8,9]] //Level 1
                    ];
var wantedItemIndexes = [ //Items to strive for, given your goal. 
                        [[0,1,8,9], [4,5,6,7], [2,3,10,11]], //Level 0
                        [[0,1,8,9], [4,5,6,7], [2,3,10,11]] //Level 1
                        ];

//Variables
var pLevel;
var pName;
var pRole;

function initialize()
{
    //Get PlayerID and GameID from URL
    var params = parseURLParams(document.URL);
    gameId = parseInt(params.gameId);
    playerId = parseInt(params.playerId);
    webPageId = parseInt(params.webPageId);
    webPageId = wpClerk;
    //Get Stuff from Server
    switch(webPageId)
    {
        case wpClerk:
            pName = "Clerk";
            pRole = roleClerk;
            break;
        case wpHunter:
            pName = "Hunter";
            pRole = roleHunter;
            break;
        case wpCrafter:
            pName = "Crafter";
            pRole = roleCrafter;
            break;
    }
    document.getElementById("roleTitle").innerHTML = pRole;
    for(levelIdIndex in levelItemIds)
        getItemCount(levelItemIds[levelIdIndex]);
    getItemCount(bogusFinishReadyId);
    refreshItemCounts();
}

function introduce()
{
  alert("introducing...");
  document.getElementById(pName).display = "block";
  for(index in roleItemIndexes[curentLevel][pRole])
  {
    setItemCount(itemIds[roleItemIndexes[currentLevel][pRole][index]],1);
    itemQtys[roleItemIndexes[currentLevel][pRole][index]]++;
  }
  draw();
  setScene(sceneIntro)
}

function draw()
{
  if(ready)
    document.getElementById("tradeTable").innerHTML = constructTradeTableHTML();
}

function refreshItemCounts()
{
    for(itemId in itemIds)
        getItemCount(itemIds[itemId]);
}

function didUpdateItemQty(updatedItemId,qty)
{
    if(updatedItemId == bogusFinishReadyId)
    {
      ready = true;
      introduce();
      return;
    }
    //alert("Found Item "+updatedItemId+" of qty "+qty);
    var newItem = false;
    for(itemIndex in itemIds)
    {
        if(updatedItemId == itemIds[itemIndex])
        {
            itemQtys[itemIndex]=qty;
            newItem = true;
        }
    }
    if(newItem) draw();

    for(levelIdIndex in levelItemIds)
        if(updatedItemId == levelItemIds[levelIdIndex] && qty > 0)
            if(currentLevel <= levelIdIndex) currentLevel = levelIdIndex;

    checkWinState();
}

function checkWinState()
{
  for(index in wantedItemIndexes[currentLevel][pRole])
    if(itemQtys[wantedItemIndexes[currentLevel][pRole][index]] <= 0)
      return false; //do nothing

  //If it gets here, we've won
  setScene(sceneWin);
}

function wasSelected(itemIndex)
{
    //alert("Selected "+itemIndex);
    itemSelected[itemIndex] = 1;
    constructBumpString();
    draw();
}

function wasDeselected(itemIndex)
{
    //alert("DeSelected "+itemIndex);
    itemSelected[itemIndex] = 0;
    constructBumpString();
    draw();
}

function bumpReceived(bumpString)
{
    //alert("BUMP! "+bumpString.toSource());
    var newItems = bumpString.newItems;
    for(items in newItems)
    {
        for(itemIndex in itemIds)
            if(itemIds[itemIndex] == newItems[items])
            {
                itemQtys[itemIndex]++;
                setItemCount(itemIds[itemIndex],itemQtys[itemIndex]);
            }
    }

    for(itemIndex in itemIds)
    {
        if(itemSelected[itemIndex])
        {
            if(itemQtys[itemIndex] > 0) itemQtys[itemIndex]--;
            itemSelected[itemIndex] = 0;
            setItemCount(itemIds[itemIndex],itemQtys[itemIndex]);
        }
    }
}

function constructBumpString()
{
    var bumpString = "{\"tradedItems\":[";
    for(itemIndex in itemIds)
    {
        if(itemSelected[itemIndex])
            bumpString += itemIds[itemIndex]+",";
    }
    if(bumpString.charAt(bumpString.length-1) == ",")
        bumpString = bumpString.slice(0,-1);

    bumpString += "]}";
    setBumpString(bumpString);
    return bumpString;
}

function constructTableCellHTML(itemIndex, inventorySide)
{
    var cellHTML = "";
    if(inventorySide)
    {
        if(itemSelected[itemIndex]) //was selected
            cellHTML+="<div onClick='wasDeselected("+itemIndex+")' style='background-color:#D1E0FF;'><img src='"+itemImages[itemIndex]+"' width='36' height='36'/>* "+itemNames[itemIndex]+" Qty:"+itemQtys[itemIndex]+"</div>";
        else
            cellHTML+="<div onClick='wasSelected("+itemIndex+")'><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+" Qty:"+itemQtys[itemIndex]+"</div>";
    }
    else
    {
        if(itemQtys[itemIndex]) //was found
            cellHTML+="<div style='background-color:#D1FFE0;'><img src='"+itemImages[itemIndex]+"' width='36' height='36'/>* "+itemNames[itemIndex]+"</div>";
        else
            cellHTML+="<div><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+"</div>";
    }
    return cellHTML;
}

function constructTradeTableHTML()
{
    var tableHtml = "<table width='100%' border='1' cellpadding='2' margin='2'><tr><td width='50%'>Inventory</td><td width='50%'>Want</td></tr>";
    var inventoryIndex = 0;
    for(var i = 0; i < itemIds.length; i++)
    {
        tableHtml+="<tr><td>";
            //Ok, this part is weird, but you're just gonna have to trust me
            while(inventoryIndex < itemQtys.length && itemQtys[inventoryIndex]<=0)
                inventoryIndex++;
            if(inventoryIndex < itemQtys.length)
                tableHtml+=constructTableCellHTML(inventoryIndex,1);
                inventoryIndex++;
        tableHtml+="</td><td>";
            if(i < wantedItemIndexes[currentLevel][pRole].length)
                tableHtml+=constructTableCellHTML(wantedItemIndexes[currentLevel][pRole][i],0);
        tableHtml+="</td></tr>";
    }
    tableHtml += "</table>";
    //alert(tableHtml);
    return tableHtml;
}

function getAdvice()
{
    alert("Advice!");
}

</script>
<style>
div
{
    /*
        border-style:solid;
        border-width:1px;
        border-color:#FF0000;
    */
    padding:0px;
    font-weight:Bold;
}

body
{
  -webkit-user-select:none;
  user-select:none;
}

.scene
{
  /* For some reason, adding border fixes the white bar at the top. */
  border-style:solid;
  border-width:2px;
  border-color:#000000;
  width:100%;
  height:100%;
  display:none;
  /*background-color:#000000;*/
}

.subtitle
{
        
}
    
.screenSplit
{
        
}
    
.notifications
{
  
}

</style>
</head>
<body onLoad="loadMe()" style="margin:0px; padding:0px;">
<div id="tradeScreen" style="position:relative; margin:0px; width:320px; height:416px;">

<!-- Loading State -->
<div id="loading" class="scene" style="display:block;">
  <div style="color:#FFFFFF; position:absolute; top:198px; left:130px; height:20px; width:60px;">
  loading...
  </div>
</div>

<!-- Intro State -->
<div id="intro" class="scene" onClick="setScene(2)">
    <div id="Clerk">
        <div id="1">
        </div>
        <div id="2">
        </div>
        <div id="3">
        </div>
    </div>
</div>

<!-- Trade State -->    
<div id="trade" class="scene"> <!-- style="background-image:url('images/background7.jpg');" -->
<!--
 <div id="bumpLogo" class="subtitle">
 </div>
-->
 <div id="roleTitle">
 </div>
    
 <div id="tradeTable">
    <!-- html gets directly injected into this; hardcode stuff here at own discretion -->
 </div>
    
 <div id="helperArea" style="position:absolute; bottom:0;">
    <img src="helper.jpg" width="50" height="50" onClick="getAdvice()"/>
 </div>

</div>

<!-- Win State -->
<div id="win" class="scene">
  <div style="color:#FFFFFF; position:absolute; top:198px; left:130px; height:20px; width:60px;">
      YOU WIN
  </div>
</div>

</div><!-- body -->
</body>
</html>
