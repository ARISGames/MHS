<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="viewport" content="width=device-width, user-scalable=no" />
<title>Trading Post</title>
<link href="tradingstyle.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="arisjs.js"></script>
<script type="text/javascript" src="tradingmodel.js"></script>
<script type="text/javascript">

var scene = sceneIntro;
var bogusEndOfQueueId = 99999999; //Enqueue into getQtyOfItem- when it returns '0', you'll know everything preceding it has finished

function bodyLoad()
{
    setTimeout(function(){initialize()},100);
}

function setScene(newScene)
{
    scene = newScene;

    document.getElementById("loading").style.display="none";
    document.getElementById("intro").style.display="none";
    document.getElementById("trade").style.display="none";
    document.getElementById("success").style.display="none";

    switch(scene)
    {
        case sceneLoading:
            document.getElementById("loading").style.display="block";
            break;
        case sceneIntro:
            document.getElementById("intro").style.display="block";
            break;
        case sceneTrade:
            draw();
            document.getElementById("trade").style.display="block";
            break;
        case sceneSuccess:
            document.getElementById("success").style.display="block";
            break;
    }
}

//Fetches all data it needs
function initialize()
{
    //Get URL Fields
    var params = parseURLParams(document.URL);
    gameId     = parseInt(params.gameId);
    playerId   = parseInt(params.playerId);
    webPageId  = parseInt(params.webPageId);
    player = new Player();

    for(i in items)
        getItemCount(items[i].itemId);
    for(i in levelIds)
        getItemCount(i);
    for(i in players)
        getItemCount(players[i].roleId);
    getItemCount(bogusEndOfQueueId); //Enqueued to signal the queue has sufficiently advanced *NOT 100% RELIABLE.
}

//Once all data is retreived, actually initialize game state
function postInit()
{
    player.construct();
    //Check if they are deserving of a reset (new to game, switched role, lost entire inventory)
    if(!oldRole || player.description.role != oldRole.role || player.inventory.length == 0)
    {
        //Wipe away relevant inventory and start fresh
        for(i in items)
        {
            setItemCount(items[i].description.itemId,0); //Back to ARIS
            player.completelyRemoveItemFromInventory(items[i].description.type); //Local
        }

        for(i in player.description.givenItems)
        {
            setItemCount(player.description.givenItems[i].itemId,1); //Back to ARIS
            player.setItemQtyInInventory(player.description.givenItems[i].type,1); //Local
        }
    }
    playIntro(0);
}

//This is called by ARIS, informing this webpage of qty values
function didUpdateItemQty(updatedItemId,qty)
{
    if(updatedItemId == bogusFinishReadyId)
    {
        postInit();
        return;
    }

    if(var i = itemDescriptionForItemId(updatedItemId)) player.setItemQtyInInventory(i.type, qty);
    else if(var l = levelForLevelId(updatedItemId) && qty > 0 && l > player.level) player.level = l;
    else if(var r = playerDescriptionForRoleId(updatedItemId) && qty > 0) oldRole = r;

    draw();
    checkWinState();
}

function playIntro(state)
{
    document.getElementById(sceneIntro).onClick="playIntro("+(state+1)+")";
    switch(state)
    {
        case 0:
            document.getElementById(player.description.title).display = "block";
            setScene(sceneIntro);
            break;
        case 1:
            setScene(sceneTrade);
            break;
    }
}

function draw()
{
    if(scene = sceneTrade)
    {
        document.getElementById("roleTitle").innerHTML = player.description.title;
        document.getElementById("tradeTable").innerHTML = constructTradeTableHTML();
    }
}

function checkWinState()
{
    if(player.hasAllNeededItems)
    {
        setScene(sceneSuccess);
        setItemCount(levelItemIds[player.level+1],1);
    }
}

function wasSelected(itemType)
{
    if(var item = player.hasItem(itemType)) item.selected = true;
    constructBumpString();
    draw();
}

function wasDeselected(itemType)
{
    if(var item = player.hasItem(itemType)) item.selected = false;
    constructBumpString();
    draw();
}

function bumpReceived(bumpString)
{
    var receivedItems = bumpString.tradedItems;
    for(i in receivedItems)
    {
        var item;
        if(item = player.addItemToInventory(itemDescriptionForItemId(receivedItems[i]).type,1))
            setItemCount(receivedItems[i],item.qty);
    }

    for(i in player.inventory)
    {
        if(player.inventory[i].selected)
        {
            var item = player.removeItemFromInventory(inventory[i].description.type,1);
            item.selected = false; //If removing item still retains qty of > 0
            setItemCount(item.description.itemId,item.qty);
        }
    }
    constructBumpString();
}

function constructBumpString()
{
    var bumpString = "{\"tradedItems\":[";
    for(i in player.inventory)
    {
        if(player.inventory[i].selected)
            bumpString += player.inventory[i].description.itemId+",";
    }
    //Remove potential trailing ','
    if(bumpString.charAt(bumpString.length-1) == ",")
        bumpString = bumpString.slice(0,-1);

    bumpString += "]}";
    setBumpString(bumpString);
    return bumpString;
}

function constructNeedsTableCell(item)
{
    var cell = ""
    cell+= "";
    cell+= "";
    cell+= "";
    cell+= "";
    cell+= "";
    cell+= "";
    return cell;
}

function constructInventoryTableCell(itemDescription)
{
    var cell = ""
    return cell;
}

function constructTradeTableHTML()
{
    var inventoryHTMLText = "";
    var wantsHTMLText = "";

    for(i in player.inventory)
    {
        inventoryHTMLText += constructInventoryTableCell(player.inventory[i]);
    }
    for(i in player.neededItems)
    {
        wantsHTMLText += constructNeedsTableCell(player.neededItems[i]);
    }
    return tableHtml;
}

function getAdvice()
{
    var neededItems = new Array();
    for(itemIndexes in wantedItemIndexes[pLevel][pRole]){
        if(itemQtys[wantedItemIndexes[pLevel][pRole][itemIndexes]] < 1){
            neededItems.push(wantedItemIndexes[pLevel][pRole][itemIndexes]);
        }
    }
    var itemAdviceIndex = Math.floor(Math.random()*neededItems.length);
    var advice = "It looks like you still need to find " + itemNames[neededItems[itemAdviceIndex]] + ". A " + roleTitles[itemOwners[neededItems[itemAdviceIndex]]] + " may have what you need."
        alert(advice);
}

</script>
</head>
<body onLoad="loadMe()" style="margin:0px; padding:0px;">
<div id="screen">

<!-- Loading State -->
<div id="loading" class="scene">
    loading...
</div>

<!-- Intro State -->
<div id="intro" class="scene">
    <div id="clerk">
    </div>
    <div id="hunter">
    </div>
    <div id="crafter">
    </div>
</div>

<!-- Trade State -->    
<div id="trade" class="scene"> 

    <div id="topBar">
    </div>
    
    <div id="tradeContent">
        <table>
            <tr>
                <td width="50%">
                    You Have
                </td>
                <td width="50%">
                    You Want
                </td>
            </tr>
            <tr>
                <td id="inventory">
                </td>
                <td id="wants">
                </td>
            </tr>
        </table>
    </div>

    
    <div id="bottomBar">
        <img src="images/voyageur.png" width="50" height="50" onClick="getAdvice()"/>
    </div>

</div>

<!-- Success State -->
<div id="success" class="scene">
    YOU WIN
</div>

<!-- Debug -->
<div id="debug">
    debug
</div> 

</div><!-- body -->
</body>
</html>
