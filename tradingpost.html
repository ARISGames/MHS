<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="viewport" content="width=device-width, user-scalable=no" />
<title>Trading Post</title>
<link href="tradingstyle.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="arisjs.js"></script>
<script type="text/javascript" src="tradingmodel.js"></script>
<script type="text/javascript">

var scene = sceneIntro;
var oldRole;
var bogusEndOfQueueId = 99999999; //Enqueue into getQtyOfItem- when it returns '0', you'll know everything preceding it has finished

function bodyLoad()
{
    setTimeout(function(){initialize()},100);
}

function setScene(newScene)
{
    scene = newScene;

    document.getElementById("loading").style.display="none";
    document.getElementById("intro").style.display="none";
    document.getElementById("trade").style.display="none";
    document.getElementById("success").style.display="none";

    switch(scene)
    {
        case sceneLoading:
            document.getElementById("loading").style.display="block";
            break;
        case sceneIntro:
            document.getElementById("intro").style.display="block";
            break;
        case sceneTrade:
            draw();
            document.getElementById("trade").style.display="block";
            break;
        case sceneSuccess:
            document.getElementById("success").style.display="block";
            break;
    }
}

//Fetches all data it needs
function initialize()
{
    //Get URL Fields
    var params = parseURLParams(document.URL);
    gameId     = parseInt(params.gameId);
    playerId   = parseInt(params.playerId);
    webPageId  = parseInt(params.webPageId);
    player = new Player();

    for(i in items)
        getItemCount(items[i].itemId);
    for(i in levelIds)
        getItemCount(levelIds[i]);
    for(i in players)
        getItemCount(players[i].roleId);
    getItemCount(bogusEndOfQueueId); //Enqueued to signal the queue has sufficiently advanced *NOT 100% RELIABLE.
}

//Once all data is retreived, actually initialize game state
function postInit()
{
    //Give them the 'Level 1' Badge for starting to play
    if(player.level == -1)
    {
        setItemCount(levelIds[0],1); //Back to ARIS
        player.level = 0;
    }

    //Finalize player state, as all data should be synced with client
    if(!player.construct(itemDescriptionForWebPageId(webPageId).owner)) alert("Error");

    //Check if they are deserving of a reset (new to game, switched role, lost entire inventory)
    if(!oldRole || player.description.role != oldRole.role || player.inventory.length == 0)
    {
        //Wipe away relevant inventory and start fresh
        for(i in items)
        {
            setItemCount(items[i].itemId,0); //Back to ARIS
            player.completelyRemoveItemFromInventory(items[i].type); //Local
        }
        for(i in player.givenItems)
        {
            setItemCount(player.givenItems[i].itemId,1); //Back to ARIS
            player.setItemQtyInInventory(player.givenItems[i].type,1); //Local
        }

        //Save New Role
        for(i in players)
        {
            if(players[i].roleId == player.description.roleId)
                setItemCount(players[i].roleId,1); //Back to ARIS
            else
                setItemCount(players[i].roleId,0); //Back to ARIS
        }
    }
    playIntro(0);
}

//This is called by ARIS, informing this webpage of qty values
function didUpdateItemQty(updatedItemId,qty)
{
    if(updatedItemId == bogusEndOfQueueId)
    {
        postInit();
        return;
    }

    var i;
    if(i = itemDescriptionForItemId(updatedItemId)) player.setItemQtyInInventory(i.type, qty);
    else if(qty > 0 && (i = levelForLevelId(updatedItemId)) != -1 && i > player.level) player.level = parseInt(i); //No idea why parseInt is necessary... oh javascript...
    else if(i = playerDescriptionForRoleId(updatedItemId) && qty > 0) oldRole = i;

    if(player.description) //Check if player has been initialized yet
    {
        draw();
        checkWinState();
    }
}

function playIntro(state)
{
    document.getElementById("intro").onclick=function(){playIntro(state+1);};
    switch(state)
    {
        case 0:
            document.getElementById("introCharacterText").innerHTML = player.description.introText;
            document.getElementById("introCharacterImage").src = player.description.imageFile;
            document.getElementById("introItemText").innerHTML = itemDescriptionForWebPageId(webPageId).introText;
            document.getElementById("introItemImage").src = itemDescriptionForWebPageId(webPageId).imageFile;
            setScene(sceneIntro);
            break;
        case 1:
            setScene(sceneTrade);
            break;
    }
}

function draw()
{
    if(scene == sceneTrade)
    {
        document.getElementById("topBarText").innerHTML = player.description.title;
        drawTradeTableHTML();
    }
}

function checkWinState()
{
    if(scene == sceneTrade && player.hasAllNeededItems())
    {
        setScene(sceneSuccess);
        setItemCount(levelIds[player.level],0); //Remove old level badge
        setItemCount(levelIds[player.level+1],1); //Give new level badge
    }
}

function cellSelected(itemType)
{
    var item;
    if(item = player.hasItem(itemType)) item.selected = !item.selected;
    constructBumpString();
    draw();
}

function bumpReceived(bumpString)
{
    var receivedItems = bumpString.tradedItems;
    for(i in receivedItems)
    {
        var item;
        if(item = player.addItemToInventory(itemDescriptionForItemId(receivedItems[i]).type,1))
            setItemCount(receivedItems[i],item.qty);
    }

    for(i in player.inventory)
    {
        if(player.inventory[i].selected)
        {
            var item = player.removeItemFromInventory(inventory[i].description.type,1);
            item.selected = false; //If removing item still retains qty of > 0
            setItemCount(item.description.itemId,item.qty);
        }
    }
    constructBumpString();
}

function constructBumpString()
{
    var bumpString = "{\"tradedItems\":[";
    for(i in player.inventory)
    {
        if(player.inventory[i].selected)
            bumpString += player.inventory[i].description.itemId+",";
    }
    //Remove potential trailing ','
    if(bumpString.charAt(bumpString.length-1) == ",")
        bumpString = bumpString.slice(0,-1);

    bumpString += "]}";
    setBumpString(bumpString);
    return bumpString;
}

function constructInventoryTableCell(item)
{
    var cell = ""
        if(item.selected)
            cell+= "<div id='hasCell"+item.description.type+"' class='hasCell selectedCell' onclick='cellSelected("+item.description.type+")'>";
        else
            cell+= "<div id='hasCell"+item.description.type+"' class='hasCell' onclick='cellSelected("+item.description.type+")'>";
    cell+= "<img id='hasCellIcon"+item.description.type+"' class='hasCellIcon' src='"+item.description.imageFileIcon+"' />";
    cell+= "<div id='hasCellTitle"+item.description.type+"' class='hasCellTitle'>"+item.description.specificName+"</div>";
    cell+= "<div id='hasCellQty"+item.description.type+"' class='hasCellQty'>x"+item.qty+"</div>";
    cell+= "</div>";
    return cell;
}

function constructNeedsTableCell(itemDescription)
{
    var cell = ""
        if(player.hasItem(itemDescription.type))
        {
            cell+= "<div id='needsCell"+itemDescription.type+"' class='needsCell verifiedCell'>";
            cell+= "<img id='needsCellIcon"+itemDescription.type+"' class='needsCellIcon' src='"+itemDescription.imageFileIcon+"' />";
            cell+= "<div id='needsCellTitle"+itemDescription.type+"' class='needsCellTitle'>"+itemDescription.specificName+"</div>";
        }
        else
        {
            cell+= "<div id='needsCell"+itemDescription.type+"' class='needsCell'>";
            cell+= "<img id='needsCellIcon"+itemDescription.type+"' class='needsCellIcon' src='"+itemDescription.imageFileIcon+"' />";
            cell+= "<div id='needsCellTitle"+itemDescription.type+"' class='needsCellTitle'>"+itemDescription.generalName+"</div>";
        }
    cell+= "</div>";
    return cell;
}

function drawTradeTableHTML()
{
    var inventoryHTMLText = "";
    var wantsHTMLText = "";

    for(i in player.inventory)
    {
        inventoryHTMLText += constructInventoryTableCell(player.inventory[i]);
    }
    for(i in player.neededItems)
    {
        wantsHTMLText += constructNeedsTableCell(player.neededItems[i]);
    }
    document.getElementById("inventory").innerHTML = inventoryHTMLText;
    document.getElementById("wants").innerHTML = wantsHTMLText;
}

function getAdvice()
{
    var itemsRemaining = new Array();
    for(i in player.neededItems)
    {
        if(!player.hasItem(player.neededItems[i].type))
            itemsRemaining.push(player.neededItems[i]);
    }
    var item;
    var advice;
    if(itemsRemaining.length > 0)
    {
        item = itemsRemaining[Math.floor(Math.random()*itemsRemaining.length)];
        advice = "It looks like you still need to find " + item.generalName + ". A " + item.owner.title + " may have what you need."
    }
    else
    {
        advice = "It looks like you've got everything you need! Good work!";
        checkWinState();
    }
    alert(advice);
}

</script>
</head>
<body onLoad="bodyLoad()" style="margin:0px; padding:0px;">
<div id="screen">

<!-- Loading State -->
<div id="loading" class="scene">
    loading...
</div>

<!-- Intro State -->
<div id="intro" class="scene">
    <div id="introCharacter">
      <div id="introCharacterText">
      </div>
      <img id="introCharacterImage" src="" />
    </div>
    <div id="introItem">
      <div id="introItemText">
      </div>
      <img id="introItemImage" src="" />
    </div>
</div>

<!-- Trade State -->    
<div id="trade" class="scene"> 
    <div id="topBar">
        <div id="topBarText">
        </div>
    </div>
    
    <div id="tradeContent">
        <table id="tradeTable">
            <tr>
                <td width="50%">
                    You Have
                </td>
                <td width="50%">
                    You Want
                </td>
            </tr>
            <tr>
                <td id="inventory">
                </td>
                <td id="wants">
                </td>
            </tr>
        </table>
    </div>
    
    <div id="bottomBar">
        <img src="images/voyageur.png" id="helper" onclick="getAdvice()"/>
    </div>

</div>

<!-- Success State -->
<div id="success" class="scene">
    YOU WIN
</div>

<!-- Debug -->
<div id="debug">
    debug
</div> 

</div><!-- body -->
</body>
</html>
