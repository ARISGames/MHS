<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name = "viewport" content = "width=device-width, user-scalable=no" />
<title>Trading Post</title>
<script type = "text/javascript" src = "arisjs.js"></script>

<script type = "text/javascript">

function loadMe()
{
    setScene(sceneIntro);
    setTimeout(function(){initialize()},delay);
}

function setScene(scene)
{
    document.getElementById("loading").style.display="none";
    document.getElementById("intro").style.display="none";
    document.getElementById("trade").style.display="none";

    switch(scene)
    {
        case sceneLoading:
            document.getElementById("loading").style.display="block";
            break;
        case sceneIntro:
            document.getElementById("intro").style.display="block";
            break;
        case sceneTrade:
            document.getElementById("trade").style.display="block";
            break;
    }
}

//Constants
var delay = 300;
//Enums
var sceneLoading = 0;
var sceneIntro = 1;
var sceneTrade = 2;
var wpClerk = 0;
var wpHunter = 1;
var wpCrafter = 2;
var roleClerk = 0;
var roleHunter = 1;
var roleCrafter = 2;

//Game Data
var gameId; 
var playerId;
var webPageId;
    
var itemIds =      new Array(1,2,3,4,5,6,7,8,9,10,11,12);
var itemQtys =     new Array(1,2,3,4,5,6,7,8,9,10,11,12);
var itemSelected = new Array(0,0,0,0,0,0,0,0,0,0, 0, 0);
var itemImages = new Array("img.png","img.png","img.png","img.png","img.png","img.png","img.png","img.png","img.png","img.png","img.png","img.png");
//*NOTE*- 
// These next two arrays are *NOT* holding values of item ids, rather, indexes into the itemId array that DOES hold the item IDs.
// This is to allow for one-spot switching of item IDs, and these can be used consistently in functions that rely on the 
// parallelocity of the 'itemIds', 'itemQtys', 'itemImages', etc... arrays
var roleItemIndexes = new Array(new Array(4,5,10,11), new Array(0,1,2,3), new Array(6,7,8,9));
var wantedItemIndexes = new Array(new Array(), new Array(), new Array());

//Variables
var pLevel;
var pName;
var pRole;

function initialize()
{
    //Get PlayerID and GameID from URL
    var params = parseURLParams(document.URL);
    gameId = parseInt(params.gameId);
    playerId = parseInt(params.playerId);
    webPageId = parseInt(params.webPageId);

    //Get Stuff from Server
    switch(webPageId)
    {
        case wpClerk:
            pName = "Clerk";
            pRole = roleClerk;
            break;
        case wpHunter:
            pName = "Hunter";
            pRole = roleHunter;
            break;
        case wpCrafter:
            pName = "Crafter";
            pRole = roleCrafter;
            break;
    }

    refreshItemCounts();
}

function draw()
{
    document.getElementById("tradeTable").innerHtml = constructTradeTableHTML();
}

function refreshItemCounts()
{
    for(itemId in itemIds)
        getItemCount(itemIds[itemId]);
}

function didUpdateItemQty(updatedItemId,qty)
{
    for(itemIndex in itemIds)
    {
        if(updatedItemId == itemIds[itemIndex])
            itemQtys[itemIndex]=qty;
    }
    draw();
}

function wasSelected(itemIndex)
{
    itemSelected[itemIndex] = 1;
    constructBumpString();
    draw();
}

function wasDeselected(itemIndex)
{
    itemSelected[itemIndex] = 0;
    constructBumpString();
    draw();
}

function bumpReceived(bumpString)
{
    var newItems = eval("("+bumpString+")").newItems;
    for(items in newItems)
    {
        for(itemIndex in itemIds)
            if(itemIds[itemIndex] == newItems[items])
                itemQtys[itemIndex]++;
    }

    for(itemIndex in itemIds)
    {
        if(itemSelected[itemIndex])
        {
            if(itemQtys[itemIndex] > 0) itemQtys[itemIndex]--;
            itemSelected[itemIndex] = 0;
        }
    }
}

function constructBumpString()
{
    var bumpString = "{\"tradedItems\":[";
    for(itemIndex in itemIds)
    {
        if(itemSelected[itemIndex])
            bumpString += itemIds[itemIndex]+",";
    }
    if(bumpString.charAt(bumpString.length-1) == ",")
        bumpString.slice(0,-1);

    bumpString += "]}";
    setBumpString(bumpString);
    return bumpString;
}

function constructTableCellHTML(itemIndex, inventorySide)
{
    var cellHTML = "";
    if(inventorySide)
    {
        if(itemSelected[itemIndex]) //was selected
            cellHTML+="<div onClick='wasSelected("+itemIndex+")'><img src='"+itemImages[itemIndex]+"' width='50' height='50'/>* Qty:"+itemQtys[itemIndex]+"</div>";
        else
            cellHTML+="<div onClick='wasDeselected("+itemIndex+")'><img src='"+itemImages[itemIndex]+"' width='50' height='50'/> Qty:"+itemQtys[itemIndex]+"</div>";
    }
    else
    {
        if(itemQtys[itemIndex]) //was found
            cellHTML+="<div><img src='"+itemImages[itemIndex]+"' width='50' height='50'/>*</div>";
        else
            cellHTML+="<div><img src='"+itemImages[itemIndex]+"' width='50' height='50'/></div>";
    }
}

function constructTradeTableHTML()
{
    var tableHtml = "<table width='100%' padding='0' margin='0'><tr><td width='50%'>Inventory</td><td width='50%'>Want</td></tr>";
    var inventoryIndex = 0;
    for(var i = 0; i < itemIds.length; i++)
    {
        tableHtml+="<tr><td>";
            //Ok, this part is weird, but you're just gonna have to trust me
            while(inventoryIndex < itemQtys.length && itemQtys[inventoryIndex]<=0)
                inventoryIndex++;
            if(inventoryIndex < itemQtys.length)
                tableHtml+=constructTableCellHTML(itemIds[inventoryIndex],1);
        tableHtml+="</td><td>";
            if(i < wantedItemIndexes[pRole].length)
                tableHtml+=constructTableCellHTML(wantedItemIndexes[pRole][i],0);
        tableHtml+="</td></tr>";
    }
    tableHtml += "</table>";
    return tableHtml;
}

//update health and xp in ARIS
//setItemCount(HEALTH_ITEM_ID, pHealth); //setItemCountForPlayer(gameId, playerId, HEALTH_ITEM_ID, pHealth);
//setItemCount(XP_ITEM_ID, pXP); //setItemCountForPlayer(gameId, playerId, XP_ITEM_ID, pXP);

</script>
<style>
div
{
    /*
        border-style:solid;
        border-width:1px;
        border-color:#FF0000;
    */
    padding:0px;
    color:white;
    font-family:Noteworthy;
    font-weight:Bold;
}

body
{
  -webkit-user-select:none;
  user-select:none;
}

.scene
{
  /* For some reason, adding border fixes the white bar at the top. */
  border-style:solid;
  border-width:2px;
  border-color:#000000;
  width:100%;
  height:100%;
  display:none;
  /*background-color:#000000;*/
}

.subtitle
{
        
}
    
.screenSplit
{
        
}
    
.notifications
{
  
}

</style>
</head>
<body onLoad="loadMe()" style="margin:0px; padding:0px;">
<div id="tradeScreen" style="position:relative; margin:0px; width:320px; height:416px;">

<!-- Loading State -->
<div id="loading" class="scene" style="display:block;">
  <div style="color:#FFFFFF; position:absolute; top:198px; left:130px; height:20px; width:60px;">
  loading...
  </div>
</div>

<!-- Intro State -->
<div id="intro" class="scene">
</div>

<!-- Trade State -->    
<div id="trade" class="scene"> <!-- style="background-image:url('images/background7.jpg');" -->
<!--
 <div id="bumpLogo" class="subtitle">
 </div>
-->
    
 <div id="tradeTable">
    <!-- html gets directly injected into this; hardcode stuff here at own discretion -->
 </div>
    
 <div id="helperArea" class="notifications">
 </div>

</div>

<!-- Win State -->
<div id="win" class="scene">
  <div style="color:#FFFFFF; position:absolute; top:198px; left:130px; height:20px; width:60px;">
      YOU WIN
  </div>
</div>

<!-- Lose State -->    
<div id="lose" class="scene">
  <div style="color:#FFFFFF; position:absolute; top:198px; left:130px; height:20px; width:60px;">
      YOU LOSE
  </div>
</div>

</div><!-- body -->
</body>
</html>
