<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="viewport" content="width=device-width, user-scalable=no" />
<title>Trading Post</title>
<link href="tradingstyle.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="arisjs.js"></script>
<script type="text/javascript" src="tradingmodel.js"></script>
<script type="text/javascript">

var scene = sceneIntro;
var minLevel = 0; //Used to keep running count of what level the player is possibly at before all items are retrieved, and before player object is initialized
var oldRole = null; //Used to know whether or not to wipe inventory
var bogusEndOfQueueId = 99999999; //Enqueue into getQtyOfItem- when it returns '0', you'll know everything preceding it has finished

function bodyLoad()
{
    setTimeout(function(){initialize()},100);
}

function setScene(newScene)
{
    scene = newScene;

    document.getElementById("loading").style.display="none";
    document.getElementById("intro").style.display="none";
    document.getElementById("trade").style.display="none";
    document.getElementById("success").style.display="none";

    switch(scene)
    {
        case sceneLoading:
            document.getElementById("loading").style.display="block";
            break;
        case sceneIntro:
            document.getElementById("intro").style.display="block";
            break;
        case sceneTrade:
            draw();
            document.getElementById("trade").style.display="block";
            break;
        case sceneSuccess:
            document.getElementById("success").style.display="block";
            break;
    }
}

//Fetches all data it needs
function initialize()
{
    //Get URL Fields
    var params = parseURLParams(document.URL);
    gameId     = parseInt(params.gameId);
    playerId   = parseInt(params.playerId);
    webPageId  = parseInt(params.webPageId);

    for(i in items)
        getItemCount(items[i].itemId);
    for(i in levelIds)
        getItemCount(i);
    for(i in players)
        getItemCount(players[i].roleId);
    getItemCount(bogusEndOfQueueId); //Enqueued to signal the queue has sufficiently advanced *NOT 100% RELIABLE.
}

//Once all data is retreived, actually initialize game state
function postInit()
{
    player = new player(itemDescriptionForWebPageId(webPageId).owner,minLevel);
    if(!oldRole || player.description.role != oldRole.role)
    {
        //Wipe away relevant inventory and start fresh
        for(i in items)
        {
            setItemCount(items[i].description.itemId,0); //Back to ARIS
            completelyRemoveItemFromInventory(items[i].description.type); //Local
        }

        for(i in player.description.givenItems)
        {
            setItemCount(player.description.givenItems[i].itemId,1); //Back to ARIS
            setItemQtyInInventory(player.description.givenItems[i].type,1); //Local
        }
    }
    playIntro(0);
}

//This is called by ARIS, informing this webpage of qty values
function didUpdateItemQty(updatedItemId,qty)
{
    if(updatedItemId == bogusFinishReadyId)
    {
        postInit();
        return;
    }

    if(var i = itemDescriptionForItemId(updatedItemId)) setItemQtyInInventory(i.type, qty);
    else if(var l = levelForLevelId(updatedItemId) && qty > 0) if(l > minLevel) minLevel = l;
    else if(var r = playerDescriptionForRoleId(updatedItemId) && qty > 0) oldRole = r;

    draw();
    checkWinState();
}

function playIntro(state)
{
    document.getElementById(sceneIntro).onClick="playIntro("+(state+1)+")";
    switch(state)
    {
        case 0:
            document.getElementById(player.description.title).display = "block";
            setScene(sceneIntro);
            break;
        case 1:
            setScene(sceneTrade);
            break;
    }
}

function draw()
{
    if(scene = sceneTrade)
        document.getElementById("tradeTable").innerHTML = constructTradeTableHTML();
}

function checkWinState()
{
    if(!ready || !introduced) return false;
    //alert(JSON.stringify(itemQtys));
    for(index in wantedItemIndexes[pLevel][pRole])
    {
        //alert("Index:"+index+" Level:"+pLevel+" Role:"+pRole);
        if(itemQtys[wantedItemIndexes[pLevel][pRole][index]] <= 0)
            return false; //do nothing
    }

    //If it gets here, we've won
    setScene(sceneSuccess);
    setItemCount(levelItemIds[pLevel],1);
}

function wasSelected(itemIndex)
{
    //alert("Selected "+itemIndex);
    itemSelected[itemIndex] = 1;
    constructBumpString();
    draw();
}

function wasDeselected(itemIndex)
{
    //alert("DeSelected "+itemIndex);
    itemSelected[itemIndex] = 0;
    constructBumpString();
    draw();
}

function bumpReceived(bumpString)
{
    var newItems = bumpString.tradedItems;
    //document.getElementById("debug").innerHTML+="1";
    for(items in newItems)
    {
        //document.getElementById("debug").innerHTML+="2";
        for(itemIndex in itemIds)
            if(itemIds[itemIndex] == newItems[items])
            {
                itemQtys[itemIndex]++;
                setItemCount(itemIds[itemIndex],itemQtys[itemIndex]);
            }
    }

    for(itemIndex in itemIds)
    {
        //document.getElementById("debug").innerHTML+="3";
        if(itemSelected[itemIndex])
        {
            if(itemQtys[itemIndex] > 0) itemQtys[itemIndex]--;
            itemSelected[itemIndex] = 0;
            setItemCount(itemIds[itemIndex],itemQtys[itemIndex]);
        }
    }
    //document.getElementById("debug").innerHTML+="4";
    constructBumpString();
}

function constructBumpString()
{
    var bumpString = "{\"tradedItems\":[";
    for(itemIndex in itemIds)
    {
        if(itemSelected[itemIndex])
            bumpString += itemIds[itemIndex]+",";
    }
    if(bumpString.charAt(bumpString.length-1) == ",")
        bumpString = bumpString.slice(0,-1);

    bumpString += "]}";
    setBumpString(bumpString);
    return bumpString;
}

function constructTableCellHTML(itemIndex, inventorySide)
{
    var cellHTML = "";
    if(inventorySide)
    {
        if(itemSelected[itemIndex]) //was selected
            cellHTML+="<div onClick='wasDeselected("+itemIndex+")' style='background-color:#D1E0FF;'><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+" Qty:"+itemQtys[itemIndex]+"</div>";
        else
            cellHTML+="<div onClick='wasSelected("+itemIndex+")'><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+" Qty:"+itemQtys[itemIndex]+"</div>";
    }
    else
    {
        if(itemQtys[itemIndex]) //was found
            cellHTML+="<div style='background-color:#D1FFE0;'><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+"</div>";
        else
            cellHTML+="<div><img src='"+itemImages[itemIndex]+"' width='36' height='36'/> "+itemNames[itemIndex]+"</div>";
    }
    return cellHTML;
}

function constructTradeTableHTML()
{
    var tableHtml = "<table width='100%' ><tr><td width='50%'>Inventory<br /><br /></td><td width='50%'>Want</td></tr>";
    var inventoryIndex = 0;
    for(var i = 0; i < itemIds.length; i++)
    {
        tableHtml+="<tr><td>";
        //Ok, this part is weird, but you're just gonna have to trust me
        while(inventoryIndex < itemQtys.length && itemQtys[inventoryIndex]<=0)
            inventoryIndex++;
        if(inventoryIndex < itemQtys.length)
            tableHtml+=constructTableCellHTML(inventoryIndex,1);
        inventoryIndex++;
        tableHtml+="</td><td>";
        if(i < wantedItemIndexes[pLevel][pRole].length)
            tableHtml+=constructTableCellHTML(wantedItemIndexes[pLevel][pRole][i],0);
        tableHtml+="</td></tr>";
    }
    tableHtml += "</table>";
    //alert(tableHtml);
    return tableHtml;
}

function getAdvice()
{
    var neededItems = new Array();
    for(itemIndexes in wantedItemIndexes[pLevel][pRole]){
        if(itemQtys[wantedItemIndexes[pLevel][pRole][itemIndexes]] < 1){
            neededItems.push(wantedItemIndexes[pLevel][pRole][itemIndexes]);
        }
    }
    var itemAdviceIndex = Math.floor(Math.random()*neededItems.length);
    var advice = "It looks like you still need to find " + itemNames[neededItems[itemAdviceIndex]] + ". A " + roleTitles[itemOwners[neededItems[itemAdviceIndex]]] + " may have what you need."
        alert(advice);
}

</script>
</head>
<body onLoad="loadMe()" style="margin:0px; padding:0px;">
<div id="screen">

<!-- Loading State -->
<div id="loading" class="scene">
    loading...
</div>

<!-- Intro State -->
<div id="intro" class="scene">
    <div id="clerk">
    </div>
    <div id="hunter">
    </div>
    <div id="crafter">
    </div>
</div>

<!-- Trade State -->    
<div id="trade" class="scene"> 

    <div id="topBar">
    </div>
    
    <div id="tradeContent">
        <table>
            <tr>
                <td width="50%">
                    You Have
                </td>
                <td width="50%">
                    You Want
                </td>
            </tr>
            <tr>
                <td id="inventory">
                </td>
                <td id="wants">
                </td>
            </tr>
        </table>
    </div>

    
    <div id="bottomBar">
        <img src="images/voyageur.png" width="50" height="50" onClick="getAdvice()"/>
    </div>

</div>

<!-- Success State -->
<div id="success" class="scene">
    YOU WIN
</div>

<!-- Debug -->
<div id="debug">
    debug
</div> 

</div><!-- body -->
</body>
</html>
